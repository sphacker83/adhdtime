`docs/dataset-guide.md`, `docs/dataset-schemas.md`를 기준으로 작업합니다.

# Template Contextual Regen v2 작성 가이드

## 목적
- 추천 엔진용 `templates`를 사람이 읽을 수 있는 고품질 문장으로 신규 작성한다.
- 모든 생성물은 스키마/검증 규칙을 통과해야 하며, 통과하지 못한 건은 폐기 또는 재작성한다.

## 필수 원칙 (절대 규칙)
1. 배치 생성 금지
- 한 번에 여러 건을 만들지 않는다.
- 반드시 `매건(1건)` 신규 생성만 허용한다.

2. 단건 루프 강제
- 모든 작업은 아래 순서를 고정한다.
- `맥락카드 작성 -> 1건 생성 -> 맥락검증 -> dataset:validate -> 채택/폐기`

3. 우수사례 맵 참조 제한
- `health_state`, `work_admin` 우수사례 맵은 아이디어 수준 참조만 허용한다.
- 문장 복사, 부분 치환, 구조 복붙(문장 뼈대 재사용 포함)을 금지한다.

4. 멀티 에이전트 샤딩 규칙
- 샤딩 단위는 `1티켓 = 1건 처리`로 고정한다.
- 어떤 에이전트도 1티켓에서 2건 이상 생성하면 안 된다.

5. 미션 개수 규칙 (스키마 일치)
- missions는 `최소 3개`가 필수다.
- 최대 개수는 `data/validation_rules.json` 기준을 따른다.
- validation_rules 상 최대값이 `null`이면 상한 없음으로 해석한다.

## 단건 처리 표준 프로세스
### 1) 맥락카드 작성
- 사용자 상황/시간/제약/목표를 짧게 기록한다.
- 클러스터와 컨셉 정합성을 먼저 확인한다.

### 2) 1건 신규 생성
- title은 자연어로 작성한다.
- missions는 즉시 실행 가능한 행동 지시문으로 작성한다.
- 미션 시간(`estMin`) 합계는 `time.default`와 정확히 일치시킨다.

### 3) 맥락검증
- title과 missions가 같은 목표를 향하는지 확인한다.
- 포괄/메타/중복 표현을 제거한다.
- 우수사례 맵 문장과 표현 유사도가 높으면 즉시 폐기 후 재작성한다.

### 4) validate 실행
- `npm run -s dataset:validate`를 실행한다.
- 실패 시 해당 1건만 수정하고 루프를 다시 수행한다.

### 5) 채택/폐기
- 검증 통과 + 맥락 정합 통과 시 채택한다.
- 둘 중 하나라도 실패하면 폐기 또는 재작성 대상으로 이동한다.

## 품질 체크포인트
- title은 사람이 즉시 이해 가능한 문장이어야 한다.
- mission action은 즉시 행동 가능한 문장이어야 한다.
- 동일 클러스터 내 문장 시작 패턴 반복을 피한다.
- 실패 건은 삭제하지 말고 재작성 큐로 관리한다.

## 운영 메모
- 컨텍스트 유실 시 이 문서(`docs/promguide.md`)를 즉시 재열람한다.
- 스키마/필드/무결성 판단은 `docs/dataset-schemas.md`와 `data/validation_rules.json`을 단일 기준으로 삼는다.
